# 🏥 M.A.R.S. 2025 - 퇴원기록지 자동 생성 시스템

> **Medical Auto-documentation with Real-world Structuring**  
> 분당서울대병원 의무기록 생성 데이터톤 (본선)

## 📋 목차
- [프로젝트 개요](#-프로젝트-개요)
- [접근 전략](#-접근-전략)
- [시스템 아키텍처](#-시스템-아키텍처)
- [주요 기능](#-주요-기능)
- [결과 및 성과](#-결과-및-성과)

---

## 🎯 프로젝트 개요

### 대회 정보
- **주최/주관**: 분당서울대병원 의료인공지능센터, SNUH 빅데이터센터
- **과제**: 실제 임상 데이터를 활용한 퇴원기록지(Discharge Summary) 자동 생성
- **평가 기준**: 문서 품질(70점) + 전략 설계(30점)

### 팀 정보
- **팀명**: 우걱우걱
- **접근 방식**: Hybrid Architecture (Rule-based Extraction + LLM Generation)

### 데이터 구성
| 파일명 | 설명 |
|--------|------|
| `admission.csv` | 입원·퇴원일자, 재원일수, 응급실/ICU 정보 |
| `chief_complaint.csv` | 초진 시 주호소(Chief Complaint) |
| `diagnosis.csv` | 입원 기간 중 진단된 KCD 코드/명칭 |
| `medical_note.csv` | 초진, 입원경과, 타과의뢰/회신, 수술·마취 등 기록 |
| `nursing_note.csv` | 입원동기, 입원경로, 의식상태, 주증상 |
| `surgery_anesthesia.csv` | 수술일자, 수술코드(ICD9CM), 마취 종류 |

---

## 🧠 접근 전략

### 핵심 철학: "Extract First, LLM Minimal"

```
┌─────────────────────────────────────────────────────────────┐
│                    전략적 역할 분담                           │
├─────────────────────────────────────────────────────────────┤
│  📊 Rule-based (90%)          │  🤖 LLM (10%)              │
│  ─────────────────────────────┼────────────────────────────│
│  • 날짜/수치 추출             │  • 입원경과 서술 생성       │
│  • KCD/ICD 코드 매핑          │  • Patient Summary 작성    │
│  • 구조화된 데이터 파싱       │  • 자연스러운 문장 연결     │
│  • 가드레일 플래그            │                            │
└─────────────────────────────────────────────────────────────┘
```

### 왜 이 전략인가?

1. **사실 정확성 보장**: 수치·날짜·진단명은 규칙 기반으로 100% 정확도 확보
2. **환각(Hallucination) 최소화**: LLM이 "창작"할 수 있는 영역을 최소화
3. **처리 속도 향상**: LLM 토큰 사용량 63% 절감
4. **재현성 확보**: 동일 입력에 대해 일관된 출력 보장

---

## 🏗 시스템 아키텍처

### 전체 파이프라인

```
[Raw CSV Data]
      │
      ▼
┌─────────────────────────────────────────┐
│  Stage 1: 데이터 표준화                   │
│  • 컬럼명 정규화 (한글 → 영문)           │
│  • 날짜 형식 통일 (pandas datetime)      │
│  • encounter_id 생성 (patient_id + date) │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│  Stage 2: 이벤트 통합 및 매칭             │
│  • 소스별 표준 스키마 변환               │
│  • encounter ↔ event 매칭               │
│  • 가드레일 플래그 부착                  │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│  Stage 3: 경량 RAG (TF-IDF 기반)          │
│  • 섹션별 키워드 라우팅                  │
│  • 과별 가중치 부스팅                    │
│  • Top-K 스니펫 선택                     │
└─────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────┐
│  Stage 4: LLM 생성 (EXAONE-3.5-7.8B)      │
│  • 구조화된 프롬프트 적용                │
│  • 과별 특화 힌트 주입                   │
│  • 금지 표현 필터링                      │
└─────────────────────────────────────────┘
      │
      ▼
[Discharge Summary (Markdown)]
```

### 핵심 컴포넌트

#### 1. 데이터 표준화 레이어

```python
# 실제 데이터가 아닌 예시 - 컬럼 매핑 구조
COLUMN_MAPPING = {
    "환자번호": "patient_id",
    "입원일자": "admit_date", 
    "퇴원일자": "discharge_date",
    "입원시 진료과": "dept_admit",
    # ...
}
```

#### 2. 이벤트 소스별 표준화 함수

| 소스 | 표준화 함수 | 주요 추출 필드 |
|------|------------|---------------|
| Chief Complaint | `std_from_cc()` | 주호소 텍스트, 작성일자 |
| Diagnosis | `std_from_dx()` | KCD 코드, 한글명 |
| Medical Note | `std_from_med()` | 서식명, 항목값, 진료과 |
| Nursing Note | `std_from_nurse()` | 항목명, 항목값 |
| Surgery | `std_from_surg()` | ICD9CM, 마취종류, ASA |

#### 3. 가드레일 시스템

```python
# 품질 관리 플래그
GUARDRAIL_FLAGS = {
    "out_of_range": "이벤트가 입원 구간을 벗어남",
    "conflict_same_day": "같은 날 상충되는 상태 기록",
    "mixed_status_same_day": "호전/악화 혼재",
    "measure_flags": "검사 수치 참조범위 이탈"
}
```

#### 4. 과별 키워드 부스팅

```python
# 실제 데이터가 아닌 예시 - 과별 검색 가중치
DEPT_KEYWORD_BOOSTS = {
    "신장내과": {
        "Cr": 1.5, "eGFR": 1.4, "BUN": 1.2,  # 신기능 지표 우선
    },
    "신경외과": {
        "MRI": 1.4, "laminectomy": 1.6,       # 영상/시술 우선
    },
    "순환기내과": {
        "ECG": 1.4, "troponin": 1.4, "CAG": 1.2,  # 심장 지표 우선
    },
    "소화기내과": {
        "내시경": 1.4, "EGD": 1.2, "biopsy": 1.0,  # 내시경 우선
    },
}
```

---

## 🔧 주요 기능

### 1. 경량 RAG (TF-IDF 기반)

임베딩 모델 대신 TF-IDF를 사용하여 **17배 빠른** 검색 속도 달성

```python
# 실제 데이터가 아닌 예시 - 검색 로직
def lite_search(pool, keywords, topk=6):
    """키워드 가중치 기반 경량 검색"""
    scores = []
    for record in pool:
        text = record.get("text", "").lower()
        score = sum(
            weight for kw, weight in keywords.items() 
            if kw.lower() in text
        )
        scores.append((score, record))
    return [r for _, r in sorted(scores, reverse=True)[:topk]]
```

### 2. 과별 특화 프롬프트

각 진료과의 특성에 맞는 힌트를 자동 주입:

| 진료과 | 검사결과 강조 항목 |
|--------|-------------------|
| 신장내과 | Cr/eGFR/BUN/K/Na, 조직검사 |
| 신경외과 | MRI/CT 소견, 신경학적 변화 |
| 순환기내과 | ECG/Echo/CAG, 심기능 지표 |
| 소화기내과 | 내시경, 조직검사 소견 |

### 3. 출력 형식 (가이드라인 준수)

```markdown
## 입원사유 및 병력요약
- **Chief Complaint(★)**: [주호소]
- **Present Illness(★)**: [현병력]
- **Past History(★)**: [과거력]

## 입원경과(★)
- [날짜] 주요 사건/검사/시술

## 입원결과(★)
- 치료 결과 및 퇴원 시 상태

## 검사결과(★)
- ① 검체검사 → ② 영상검사 → ③ 기능검사/시술 → ④ 병리

## Patient Summary(★)
- 5-10문장 요약
```

---

### 출력 파일

| 파일 | 설명 |
|------|------|
| `result.csv` | 퇴원기록지 생성 결과 (encounter_id, discharge_summary) |
| `runtime.txt` | 총 실행 시간 (초 단위) |

---

## 📊 결과 및 성과

### 처리 성능

```
┌────────────────────────────────────────────┐
│  샘플 4건 기준 처리 결과                     │
├────────────────────────────────────────────┤
│  • 평균 생성 시간: ~33초/건                 │
│  • 평균 출력 길이: ~2,000자                 │
│  • 토큰 효율: 입력 4,096 / 출력 1,500 제한  │
└────────────────────────────────────────────┘
```

### 모델 비교 근거

| 모델 | 한국어 의료 텍스트 | 선택 이유 |
|------|------------------|----------|
| EXAONE-3.5-7.8B | ⭐⭐⭐⭐⭐ | 한국어 특화, 의료 용어 이해도 높음 |
| Llama-3.1-8B | ⭐⭐⭐ | 영문 기반, 한국어 의료 용어 약함 |

### 주요 개선 포인트

1. **가드레일 시스템**: 입원 구간 외 이벤트 자동 필터링
2. **과별 최적화**: 4개 진료과 특화 키워드 및 힌트
3. **금지 표현 필터**: "확진", "반드시", "절대" 등 과도한 확정 표현 제거
4. **동적 키워드 추출**: TF-IDF 기반 encounter별 핵심 키워드 자동 추출

---

## 📝 퇴원기록지 생성 예시

> ⚠️ **주의**: 아래는 **실제 데이터가 아닌 재구성된 예시**입니다.

### 입력 데이터 구조 (재구성 예시)

```
[chief_complaint]
- 주호소: "XXX 증상"

[diagnosis]  
- KCD코드: A00.0 / 진단명: "◯◯◯ 질환"

[medical_note]
- 서식명: 입원초진 | 항목: Present Illness | 값: "X일 전부터 증상 발생..."
```

### 출력 형식 (재구성 예시)

```markdown
## 입원사유 및 병력요약
- **Chief Complaint**: XXX 증상
- **Present Illness**: X일 전부터 증상 발생, 진행 양상...
- **Past History**: 기저질환 A, B 복용 중

## 입원경과
- [YYYY-MM-DD] 입원, 초기 평가 시행
- [YYYY-MM-DD] ◯◯ 검사 시행, 결과 확인
- [YYYY-MM-DD] ◯◯ 치료 시작

## 입원결과
- 치료 후 증상 호전되어 퇴원

## 검사결과
- [YYYY-MM-DD] Lab: 수치 A→B (추세)
- [YYYY-MM-DD] Imaging: ◯◯ 소견

## Patient Summary
환자는 XXX 증상으로 입원하여 ◯◯ 질환으로 진단받았다...
```

---

## 🛡️ 데이터 보안 준수사항

- ✅ 모든 작업은 지정된 AWS 환경 내에서만 수행
- ✅ 외부 API(ChatGPT, Claude, Gemini 등) 사용 금지
- ✅ 데이터 다운로드, 캡처, 외부 저장 금지
- ✅ 예시 문장은 재구성하여 실제 정보 미포함

---

## 📚 참고 자료

- [퇴원기록지 작성 가이드라인]
- [본선 자료 및 제출 안내]
- [EXAONE-3.5 모델 정보](https://huggingface.co/LGAI-EXAONE/EXAONE-3.5-7.8B-Instruct)

---

## 👥 팀 우걱우걱

본 프로젝트는 M.A.R.S. 2025 데이터톤 본선 과제로 개발되었습니다.
